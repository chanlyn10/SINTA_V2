<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Ketersediaan Data MKG (SINTA) BMKG V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <div class="header-custom-blue text-white p-3 d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Sistem Monitoring Ketersediaan Data MKG (SINTA) BMKG</h4>
            <div class="d-flex align-items-center">
                <a href="#" class="text-white text-decoration-none">
                    admin.mdm
                </a>
                <img src="{{ url_for('static', filename='images/logo_bmkg.png') }}" alt="BMKG Logo" class="bmkg-logo ms-2">
            </div>
        </div>

        <div class="bg-white shadow-sm p-2">
            <nav class="nav">
                <a class="nav-link active" href="#"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                <a class="nav-link text-secondary" href="#">Metadata</a>
                <a class="nav-link text-secondary" href="#">Ketersediaan Data v1</a>
                <a class="nav-link text-secondary" href="/ketersediaan_data_v2"><i class="fas fa-database me-1"></i>Ketersediaan Data v2</a>
                <a class="nav-link text-secondary" href="#">Profile</a>
                <a class="nav-link text-secondary" href="#">Tentang</a>
            </nav>
        </div>
    </header>

    <div class="container-fluid mt-4">
        <h3 class="fw-bold mb-4">Selamat Datang, Manajemen Database MKG</h3>
    </div>

    <div class="container-fluid mt-3">
        <div class="card mb-3 p-3">
            <p>Silahkan memilih periode waktu untuk melihat persentase FKLIM secara global</p>
            <div class="d-flex align-items-center">
                <select class="form-select w-25 me-2" id="select-periode">
                    <option selected>-- Pilih Waktu --</option>
                    <option value="1">7 Hari Terakhir</option>
                    <option value="2">30 Hari Terakhir</option>
                    <option value="3">365 Hari Terakhir</option>
                </select>
                <button class="btn btn-primary" id="pilih-button">Pilih</button>
            </div>
        </div>
        
        <div id="loading-spinner" class="text-center my-5 d-none">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-2 text-muted">Memuat data...</p>
        </div>
        
        <div class="card mb-3 p-3" id="stasiun-terkecil-card">
            <h6 id="h6-terkecil">3 Stasiun dengan Persentase Terkecil (Periode Waktu 7 Hari Terakhir) :</h6>
            <ul class="list-unstyled" id="ul-terkecil">
                {% for stasiun in data_persentase_terkecil %}
                <li>
                    <i class="fas fa-times text-danger"></i>
                    <span class="text-danger">{{ stasiun.persentase }}</span>
                    - {{ stasiun.id }} - {{ stasiun.nama }}
                </li>
                {% endfor %}
            </ul>
        </div>

        <h6 id="chart-title">10 Stasiun Terbaik Per Balai (Periode Waktu 7 Hari Terakhir) :</h6>
        
        <div class="row">
            {% for region_id in [1, 2, 3] %}
            <div class="col-md-4">
                <div class="card p-3 mb-3">
                    <h6 class="text-center">{{ region_mapping[region_id] }}</h6>
                    <div class="chart-container" style="height: 400px;">
                        <div class="chart-message text-center text-muted d-none">Data tidak tersedia.</div>
                        <canvas id="region_{{ region_id }}-chart"></canvas>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="row justify-content-center">
            {% for region_id in [4, 5] %}
            <div class="col-md-4">
                <div class="card p-3 mb-3">
                    <h6 class="text-center">{{ region_mapping[region_id] }}</h6>
                    <div class="chart-container" style="height: 400px;">
                        <div class="chart-message text-center text-muted d-none">Data tidak tersedia.</div>
                        <canvas id="region_{{ region_id }}-chart"></canvas>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <footer class="footer mt-auto py-3 bg-light text-muted">
        <div class="container-fluid d-flex justify-content-between">
            <div>Â© DDK2025</div>
            <div>SINTA BMKG 2.0</div>
        </div>
    </footer>

    <script>
        const dataGrafik = {{ data_grafik | tojson }};
        const region_mapping = {
            1: 'Balai I',
            2: 'Balai II',
            3: 'Balai III',
            4: 'Balai IV',
            5: 'Balai V'
        };
        const balaiColors = {
            1: 'rgba(75, 192, 192, 0.8)',
            2: 'rgba(255, 99, 132, 0.8)',
            3: 'rgba(150, 110, 80, 0.8)',
            4: 'rgba(100, 140, 180, 0.8)',
            5: 'rgba(153, 102, 255, 0.8)',
        };

        function createChart(canvasId, labels, data, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chartInstance = Chart.getChart(canvasId);
            if (chartInstance) {
                chartInstance.destroy();
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Persentase Ketersediaan Data',
                        data: data,
                        backgroundColor: color,
                        borderColor: color.replace('0.8', '1'),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Persentase'
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        function renderChartsAndMessages(grafikData, periodText) {
            const h6ChartTitle = document.getElementById('chart-title');
            h6ChartTitle.innerText = `10 Stasiun Terbaik Per Balai (Periode Waktu ${periodText}) :`;

            for (const regionId in region_mapping) {
                const regionData = grafikData[regionId] || { labels: [], data: [] };
                const labels = regionData.labels;
                const data = regionData.data;
                const canvasId = `region_${regionId}-chart`;
                const canvasElement = document.getElementById(canvasId);
                const messageElement = canvasElement.previousElementSibling;
                const color = balaiColors[regionId] || 'rgba(75, 192, 192, 0.8)';

                if (data.length > 0) {
                    messageElement.classList.add('d-none');
                    canvasElement.classList.remove('d-none');
                    createChart(canvasId, labels, data, color);
                } else {
                    const chartInstance = Chart.getChart(canvasId);
                    if (chartInstance) {
                        chartInstance.destroy();
                    }
                    messageElement.classList.remove('d-none');
                    canvasElement.classList.add('d-none');
                }
            }
        }

        function updateTerkecilList(terkecilData, periodText) {
            const h6Terkecil = document.getElementById('h6-terkecil');
            const ulTerkecil = document.getElementById('ul-terkecil');
            h6Terkecil.innerText = `3 Stasiun dengan Persentase Terkecil (Periode Waktu ${periodText}) :`;
            ulTerkecil.innerHTML = '';
            
            if (terkecilData.length > 0) {
                terkecilData.forEach(stasiun => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-times text-danger"></i>
                                    <span class="text-danger">${stasiun.persentase}</span>
                                    - ${stasiun.id} - ${stasiun.nama}`;
                    ulTerkecil.appendChild(li);
                });
            } else {
                ulTerkecil.innerHTML = '<li class="text-muted">Data tidak tersedia.</li>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const pilihButton = document.getElementById('pilih-button');
            const selectPeriode = document.getElementById('select-periode');
            const loadingSpinner = document.getElementById('loading-spinner');
            const stasiunTerkecilCard = document.getElementById('stasiun-terkecil-card');
            
            pilihButton.addEventListener('click', function() {
                const periodValue = selectPeriode.value;
                if (periodValue === '-- Pilih Waktu --') {
                    alert('Silakan pilih periode waktu!');
                    return;
                }
                
                loadingSpinner.classList.remove('d-none');
                stasiunTerkecilCard.classList.add('d-none');
                document.querySelectorAll('.card .chart-container').forEach(container => container.parentNode.classList.add('d-none'));

                fetch(`/api/dashboard_data/${periodValue}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingSpinner.classList.add('d-none');
                        stasiunTerkecilCard.classList.remove('d-none');
                        document.querySelectorAll('.card .chart-container').forEach(container => container.parentNode.classList.remove('d-none'));
                        
                        const periodText = selectPeriode.options[selectPeriode.selectedIndex].text;
                        updateTerkecilList(data.data_persentase_terkecil, periodText);
                        renderChartsAndMessages(data.data_grafik, periodText);
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        loadingSpinner.classList.add('d-none');
                        alert('Gagal memuat data. Silakan coba lagi.');
                    });
            });
            
            renderChartsAndMessages(dataGrafik, '7 Hari Terakhir');
            updateTerkecilList({{ data_persentase_terkecil | tojson }}, '7 Hari Terakhir');
        });
    </script>
</body>
</html>